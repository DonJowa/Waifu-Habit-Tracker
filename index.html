<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waifu Tracker: V81 Count Fix</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-nn: #e91e63;
            --accent-sleep: #7c4dff;
            --success: #00c853;
            --fail: #d50000;
            --neutral: #0277bd;
            --btn-inactive: #333;
            --gold: #ffd700;
            --legendary: #d500f9;
            --silver: #e0e0e0;
            --xp-bar: #00e5ff;
            --panic: #ff1744;
            --overlay-color: rgba(0, 0, 0, 0.7);
        }

        /* THEMES */
        body.theme-red { --accent-nn: #ff5252; --accent-sleep: #ff1744; --xp-bar: #ff5252; --success: #d50000; --overlay-color: rgba(50, 0, 0, 0.8); }
        body.theme-blue { --accent-nn: #448aff; --accent-sleep: #2979ff; --xp-bar: #448aff; --success: #2962ff; --overlay-color: rgba(0, 0, 50, 0.8); }
        body.theme-green { --accent-nn: #69f0ae; --accent-sleep: #00e676; --xp-bar: #00c853; --success: #00e676; --overlay-color: rgba(0, 40, 0, 0.8); }
        body.theme-gold { --bg-color: #1a1200; --card-bg: #261e05; --text-color: #fff8e1; --accent-nn: #ffd700; --accent-sleep: #ffab00; --xp-bar: #ffecb3; --btn-inactive: #4e342e; --overlay-color: rgba(40, 30, 0, 0.85); }
        body.theme-rainbow { --accent-nn: #ff00cc; --accent-sleep: #3333ff; --xp-bar: #fff; --card-bg: rgba(20, 20, 20, 0.9); }
        body.theme-rainbow #bg-layer { background-image: linear-gradient(125deg, rgba(255,0,0,0.4), rgba(255,154,0,0.4), rgba(208,222,33,0.4), rgba(79,220,74,0.4), rgba(63,218,216,0.4), rgba(47,201,226,0.4), rgba(28,127,238,0.4), rgba(95,21,242,0.4), rgba(186,12,248,0.4)), url('bg.png'); background-size: 300% 300%, 400px; animation: rainbow-move 10s ease infinite; }
        @keyframes rainbow-move { 0% { background-position: 0% 50%, 0 0; } 50% { background-position: 100% 50%, 0 0; } 100% { background-position: 0% 50%, 0 0; } }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            padding-bottom: 50px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: color 0.3s;
        }

        #bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-color: var(--bg-color); 
            background-image: linear-gradient(var(--overlay-color), var(--overlay-color)), url('bg.png');
            background-repeat: repeat; background-size: 400px;
            transition: background-image 0.5s ease;
        }

        /* TABS */
        .tabs {
            display: flex; width: 100%; max-width: 600px;
            background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 4px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            box-sizing: border-box;
        }
        .tab-btn { 
            flex: 1 1 0px; width: 0; 
            background: transparent; border: none; color: #ccc; padding: 12px 0; 
            cursor: pointer; font-size: 0.9rem; font-weight: 600; border-radius: 8px; transition: all 0.2s; 
            display: flex; justify-content: center; align-items: center; white-space: nowrap;
        }
        .tab-btn.active { background: rgba(255, 255, 255, 0.15); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        @media (max-width: 400px) { .tab-btn { font-size: 0.75rem; padding: 10px 0; } .tab-btn:last-child { font-size: 1.1rem; } }

        .content-section { 
            display: none; width: 100%; max-width: 600px; animation: fadeIn 0.3s ease; 
            padding-bottom: 220px; 
        }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* RPG HEADER */
        .rpg-header {
            width: 100%; max-width: 600px;
            background: linear-gradient(135deg, rgba(30,30,30,0.9), rgba(20,20,20,0.95));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 15px; margin-bottom: 20px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            box-sizing: border-box;
        }
        .level-badge {
            width: 60px; height: 60px; background: #333; border: 2px solid var(--xp-bar);
            border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 0 10px var(--xp-bar); flex-shrink: 0;
        }
        .lvl-num { font-size: 1.4rem; font-weight: bold; color: #fff; line-height: 1; }
        .lvl-label { font-size: 0.6rem; color: var(--xp-bar); text-transform: uppercase; }
        .xp-container { flex: 1; min-width: 0; }
        .rpg-title { font-size: 1.1rem; font-weight: bold; color: #fff; margin-bottom: 5px; letter-spacing: 1px; text-shadow: 0 2px 2px black;}
        .xp-bar-bg { width: 100%; height: 10px; background: #111; border-radius: 5px; overflow: hidden; border: 1px solid #444; }
        .xp-bar-fill { height: 100%; background: var(--xp-bar); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--xp-bar); }
        .xp-text { font-size: 0.8rem; color: #aaa; margin-top: 3px; text-align: right; }

        /* DAY CARD */
        .day-card {
            background: var(--card-bg); backdrop-filter: blur(5px);
            padding: 20px; padding-left: 24px; margin-bottom: 15px; border-radius: 16px;
            position: relative; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05);
            transition: background 0.3s;
        }
        .day-card::after { content: ''; position: absolute; top: 0; bottom: 0; left: 0; width: 8px; background: var(--btn-inactive); }
        .day-card.allowed-day::after { background: var(--success); }
        .day-card.exempt-day::after { background: var(--accent-sleep); }
        .day-card.allowed-day.exempt-day::after { background: linear-gradient(to bottom, var(--success), var(--accent-sleep)); }
        .day-card.is-today { border: 2px solid var(--accent-sleep); box-shadow: 0 0 20px rgba(124, 77, 255, 0.3); }
        .day-card.completed { opacity: 0.9; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .day-title { font-size: 1.2rem; font-weight: bold; }
        .header-right { display: flex; align-items: center; gap: 8px; }

        /* GLOBAL FAB */
        #globalPanicBtn {
            position: fixed; bottom: 20px; right: 20px; width: 120px; height: 120px;
            background: transparent; border: none; display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 900; transition: transform 0.2s;
            animation: float-chibi 3s ease-in-out infinite;
        }
        #globalPanicBtn img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px rgba(233, 30, 99, 0.5)); }
        #globalPanicBtn:active { transform: scale(0.9) rotate(-5deg); filter: brightness(0.8); }
        @keyframes float-chibi { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }

        /* SPEECH BUBBLE */
        .speech-bubble {
            position: fixed; bottom: 130px; right: 30px;
            background: white; color: #333; padding: 12px 16px; border-radius: 15px; border-bottom-right-radius: 2px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-size: 0.85rem; font-weight: bold; line-height: 1.3;
            max-width: 220px; text-align: center; z-index: 899; display: none; 
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -8px; right: 10px; width: 0; height: 0;
            border-left: 10px solid transparent; border-right: 0px solid transparent; border-top: 12px solid white; 
        }
        @keyframes pop-in { from { opacity: 0; transform: scale(0.5) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .badges { display: flex; gap: 5px; }
        .badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-allowed { background: rgba(0, 200, 83, 0.2); color: #00e676; border: 1px solid #00e676; }
        .badge-exempt { background: rgba(124, 77, 255, 0.2); color: #b388ff; border: 1px solid #b388ff; }

        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px; margin-bottom: 15px; }
        button { padding: 12px 5px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: #ddd; background: var(--btn-inactive); transition: transform 0.1s; }
        button:active { transform: scale(0.96); }
        .sleep-btn.selected { background: var(--accent-sleep); color: white; }
        .fap-btn.success-btn.selected { background: var(--success); color: black; }
        .fap-btn.fail-btn.selected { background: var(--fail); color: white; }
        .fap-btn.allowed-action.selected { background: #2e7d32; }
        .fap-btn.allowed-skip.selected { background: var(--neutral); }
        .summary-view { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 8px; }
        .edit-btn { background: transparent; border: 1px solid #555; padding: 5px 10px; font-size: 0.8rem; }

        /* SLOTS SYSTEM (3 Slots) */
        .slots-container {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 8px; margin-bottom: 20px;
            background: rgba(20,20,20,0.6); padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
        }
        .slot-box {
            aspect-ratio: 1; background: #222; border: 2px dashed #444; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; overflow: hidden; transition: all 0.1s;
            background-size: cover; background-position: center;
        }
        .slot-box:hover { transform: scale(1.05); }
        .slot-box:active { transform: scale(0.95); }
        .slot-box.filled { border-style: solid; border-color: #fff; }
        
        /* SLOT BACKGROUNDS */
        .slot-bg-common { background-image: url('card_common.jpg'); border-color: #888 !important; }
        .slot-bg-rare { background-image: url('card_rare.jpg'); border-color: var(--gold) !important; }
        .slot-bg-legendary { background-image: url('card_legendary.jpg'); border-color: var(--legendary) !important; box-shadow: 0 0 10px var(--legendary); }

        .slot-icon { width: 85%; height: 85%; object-fit: contain; filter: drop-shadow(0 0 5px rgba(0,0,0,0.8)); z-index: 2; }
        .slot-stack { position: absolute; bottom: 2px; right: 4px; font-size: 0.9rem; font-weight: 900; color: white; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; z-index: 3; }
        .slot-bonus { position: absolute; top: 2px; left: 2px; font-size: 0.6rem; color: #00e676; font-weight: 900; text-shadow: 1px 1px 0 #000; z-index: 3; background: rgba(0,0,0,0.5); padding: 1px 3px; border-radius: 4px;}
        
        .xp-boost-total { text-align: center; font-size: 0.9rem; color: var(--success); margin-bottom: 10px; font-weight: bold; text-shadow: 0 0 10px rgba(0, 200, 83, 0.3); }

        /* WAIFU CARDS */
        .waifu-grid { display: flex; gap: 20px; overflow-x: auto; padding: 25px 10px 40px 10px; scrollbar-width: none; }
        .waifu-card { 
            flex: 0 0 170px; height: 260px; padding: 0; border-radius: 14px; border: 1px solid #444;
            text-align: center; position: relative; overflow: hidden; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.1s ease, box-shadow 0.3s ease;
            background-size: cover; background-position: center; background-color: #222;
        }
        .waifu-card:active { transform: scale(0.98) translateY(-10px); }
        .waifu-card:hover { transform: translateY(-12px) scale(1.03); z-index: 10; box-shadow: 0 15px 30px rgba(0,0,0,0.7); border-color: #fff; }
        
        .bg-common { background-image: url('card_common.jpg'); border-color: #888; }
        .bg-rare { background-image: url('card_rare.jpg'); border-color: var(--gold); }
        .bg-legendary { background-image: url('card_legendary.jpg'); border-color: var(--legendary); }
        .waifu-img { width: 100%; height: 100%; object-fit: cover; object-position: center top; display: block; background: transparent; position: absolute; top: 0; left: 0; z-index: 1; transition: transform 0.5s ease; }
        .waifu-card:hover .waifu-img { transform: scale(1.1); }
        .waifu-card::before { content: ""; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: linear-gradient(115deg, transparent 30%, rgba(255, 255, 255, 0.6) 45%, rgba(255, 255, 255, 0.8) 50%, rgba(255, 255, 255, 0.6) 55%, transparent 70%); transform: skewX(-25deg); z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .waifu-card:hover::before { opacity: 1; animation: holo-sweep 0.8s forwards; }
        @keyframes holo-sweep { 0% { left: -150%; } 100% { left: 200%; } }
        .bg-legendary::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(125deg, rgba(255,0,0,0.2), rgba(255,165,0,0.2), rgba(255,255,0,0.2), rgba(0,128,0,0.2), rgba(0,0,255,0.2), rgba(75,0,130,0.2), rgba(238,130,238,0.2)); background-size: 200% 200%; mix-blend-mode: overlay; z-index: 2; opacity: 0.7; animation: rainbow-shift 4s infinite linear; pointer-events: none; }
        @keyframes rainbow-shift { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }
        .waifu-info { padding: 8px; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 70%, transparent 100%); position: absolute; bottom: 0; width: 100%; z-index: 5; }
        .waifu-label { font-size: 0.85rem; color: #fff; text-transform: uppercase; font-weight: bold; text-shadow: 0 2px 4px black; }
        .waifu-count { position: absolute; top: 8px; right: 10px; font-size: 2.2rem; font-weight: 900; line-height: 1; z-index: 6; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 10px rgba(0,0,0,0.8); }
        .count-special { color: #fff; } .count-shiny { color: var(--gold); } .count-legendary { color: var(--legendary); }

        /* TRADING BOX */
        .trade-box { background: rgba(30, 30, 30, 0.95); padding: 15px; border-radius: 12px; margin-top: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
        .trade-header { font-size: 0.85rem; color: #888; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; font-weight: bold; }
        .trade-actions { display: flex; gap: 10px; }
        .trade-btn { flex: 1; background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px; cursor: pointer; transition: transform 0.1s, background 0.2s; }
        .trade-btn:active { transform: scale(0.95); }
        .trade-btn:hover { background: #2a2a2a; border-color: #666; }
        .trade-row { font-size: 1.4rem; font-weight: 900; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; text-shadow: 0 2px 2px rgba(0,0,0,0.5); }
        .cost-silver { color: var(--silver); text-shadow: 0 0 5px rgba(224, 224, 224, 0.3); }
        .cost-gold { color: var(--gold); text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
        .gain-legendary { color: var(--legendary); text-shadow: 0 0 8px rgba(213, 0, 249, 0.4); }
        .arrow { color: #555; font-size: 1rem; }
        .trade-desc { font-size: 0.7rem; color: #888; text-transform: uppercase; }

        /* PROGRESS & STATS */
        .progress-box { background: rgba(30, 30, 30, 0.95); padding: 15px; border-radius: 12px; margin-top: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
        .stats-flex { display: flex; gap: 25px; margin-bottom: 8px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-number { font-size: 1.4rem; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .stat-label { font-size: 0.75rem; color: #aaa; text-transform: uppercase; }
        .next-reward { font-size: 0.85rem; color: #ccc; margin-left: auto; align-self: flex-end; padding-bottom: 5px; }
        .progress-track { height: 14px; background: #111; border-radius: 7px; overflow: hidden; position: relative; border: 1px solid #444; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 7px; }
        .marker { position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.3); z-index: 2; }
        .marker-shiny { left: 50%; } 
        .fill-nn { background: linear-gradient(90deg, #f48fb1, #e91e63); }
        .fill-sl { background: linear-gradient(90deg, #b388ff, #7c4dff); }

        .stat-box { background: rgba(30, 30, 30, 0.95); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05);}
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .heatmap-day { aspect-ratio: 1; border-radius: 4px; background: #333; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #aaa; }
        .heatmap-day.success { background: var(--success); color: black; }
        .heatmap-day.fail { background: var(--fail); color: white; }
        .heatmap-day.neutral { background: #555; }
        
        /* GALLERY GRID */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 15px;
        }
        .gallery-item {
            aspect-ratio: 1/1; background: #222; border-radius: 8px; border: 1px solid #444;
            display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .gallery-item.locked { opacity: 0.5; border-style: dashed; }
        .gallery-item.unlocked { cursor: pointer; border-color: var(--gold); }
        .gallery-item.unlocked:hover { transform: scale(1.05); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .lock-icon { font-size: 1.2rem; color: #555; }

        /* ANIMATION: FLYING CARD */
        .flying-card {
            position: fixed; pointer-events: none; z-index: 9999;
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); object-fit: cover;
        }

        /* MODALS */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .modal img { max-width: 100%; max-height: 80vh; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 15px; }
        @keyframes popIn { from { transform: scale(0.8); } to { transform: scale(1); } }
        
        /* NEW: INTEGRATED REWARD OVERLAY */
        .reward-overlay {
            position: absolute;
            bottom: 10%; /* Placed near bottom over character */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--gold);
            color: #fff;
            text-align: center;
            min-width: 80%;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            animation: slideUpFade 0.5s ease;
            z-index: 10001;
            font-size: 1.1rem;
            white-space: pre-line;
            pointer-events: none; /* Let click pass through to modal wrapper */
        }
        @keyframes slideUpFade { from { opacity:0; transform: translate(-50%, 20px); } to { opacity:1; transform: translate(-50%, 0); } }
        
        .reward-title { color: var(--gold); font-weight: 900; font-size: 1.4rem; margin-bottom: 10px; display:block; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 2px rgba(0,0,0,0.8); }
        .reward-item { margin: 5px 0; font-weight: bold; font-size: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
        .reward-item:last-child { border-bottom: none; }
        .tap-hint { font-size: 0.8rem; color: #aaa; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity:0.5; } 50% { opacity:1; } 100% { opacity:0.5; } }

        /* PANIC/SUCCESS MODALS */
        #panicModal, #successModal, #weeklyModal, #rewardModal { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        #panicImg, #successImg, #weeklyImg, #rewardImg { max-height: 85vh; max-width: 95vw; border: none; background: transparent; box-shadow: none; }
        #panicImg { filter: drop-shadow(0 0 20px rgba(233, 30, 99, 0.8)); animation: energetic-move 0.4s infinite alternate ease-in-out; }
        @keyframes energetic-move { 0% { transform: translateY(0) rotate(0deg) scale(1); } 25% { transform: translateY(-15px) rotate(-3deg) scale(1.02); } 50% { transform: translateY(0) rotate(3deg) scale(1.02); } 75% { transform: translateY(-7px) rotate(-1deg) scale(1.05); } 100% { transform: translateY(0) rotate(0deg) scale(1); } }
        #successImg { filter: drop-shadow(0 0 25px rgba(0, 200, 83, 0.8)); animation: joy-jump 0.6s infinite alternate ease-out; }
        @keyframes joy-jump { 0% { transform: translateY(0) scale(1); } 100% { transform: translateY(-30px) scale(1.05); } }
        #weeklyImg { filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.9)); animation: float-gold 3s infinite alternate ease-in-out; }
        @keyframes float-gold { 0% { transform: translateY(0); filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.7)); } 100% { transform: translateY(-20px); filter: drop-shadow(0 0 60px rgba(255, 215, 0, 1)); } }
        #rewardImg { filter: drop-shadow(0 0 30px rgba(0, 230, 118, 0.6)); animation: gentle-pulse 2s infinite ease-in-out; }
        @keyframes gentle-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #fireworksCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
        .action-btn { background: var(--success); width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; color: #000; }
        .archive-btn { width: 100%; padding: 15px; font-size: 1.1rem; background: linear-gradient(45deg, #ff6f00, #ffca28); color: black; font-weight: bold; margin-top: 20px; box-shadow: 0 4px 15px rgba(255, 111, 0, 0.3); border:none; border-radius: 12px; cursor: pointer;}
        
        /* THEME SELECTOR */
        .theme-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .theme-btn { height: 40px; border-radius: 8px; border: 2px solid #444; cursor: pointer; position: relative; opacity: 0.5; }
        .theme-btn.unlocked { opacity: 1; border-color: #fff; }
        .theme-btn.active { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .theme-btn::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; }
        .theme-btn.unlocked::after { content: ''; }
        .t-red { background: #d50000; } .t-blue { background: #2962ff; } .t-green { background: #00c853; }
        .t-gold { background: linear-gradient(45deg, #ffd700, #ffab00); } .t-rainbow { background: linear-gradient(90deg, red, orange, yellow, green, blue, violet); }

        .checkbox-group { margin-bottom: 20px; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; font-size: 1rem; color: #fff; margin: 5px 0; cursor: pointer; }
        .checkbox-label input { transform: scale(1.3); cursor: pointer; }
    </style>
</head>
<body>
    <div id="bg-layer"></div>
    <canvas id="fireworksCanvas"></canvas>
    
    <div id="waifuBubble" class="speech-bubble">Good job! Today is your reward day!<br>Wanna do it with me?</div>

    <div id="globalPanicBtn" onclick="triggerPanic()">
        <img id="fabImg" src="panic_button.png" alt="Action">
    </div>

    <!-- MODALS -->
    <div id="imgModal" class="modal" onclick="this.style.display='none'"><img id="modalImg" src=""></div>
    <div id="panicModal" class="modal" onclick="stopPanic()"><img id="panicImg" src="panic.png" alt="Panic!"></div>
    
    <!-- SUCCESS MODAL WITH OVERLAY -->
    <div id="successModal" class="modal" onclick="stopSuccess()">
        <img id="successImg" src="success.png" alt="Success!">
        <div id="successText" class="reward-overlay" style="display:none;"></div>
    </div>
    
    <!-- WEEKLY MODAL WITH OVERLAY -->
    <div id="weeklyModal" class="modal" onclick="stopWeekly()">
        <img id="weeklyImg" src="weekly.png" alt="Weekly Victory!">
        <div id="weeklyText" class="reward-overlay" style="display:none;"></div>
    </div>
    
    <div id="rewardModal" class="modal" onclick="stopReward()"><img id="rewardImg" src="reward1.png" alt="Reward!"></div>

    <div class="rpg-header">
        <div class="level-badge"><span class="lvl-num" id="rpg-level">1</span><span class="lvl-label">LVL</span></div>
        <div class="xp-container">
            <div class="rpg-title" id="rpg-title">Novice</div>
            <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-bar"></div></div>
            <div class="xp-text"><span id="rpg-current-xp">0</span> / <span id="rpg-next-xp">300</span> XP</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('log')">Log</button>
        <button class="tab-btn" onclick="switchTab('rewards')">Collection</button>
        <button class="tab-btn" onclick="switchTab('gallery')">Gallery</button>
        <button class="tab-btn" onclick="switchTab('stats')">Stats</button>
        <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è</button>
    </div>

    <!-- LOG SECTION -->
    <div id="log" class="content-section active">
        <div id="week-container"></div>
        <button class="archive-btn" onclick="archiveWeek()">Archive Week</button>
    </div>

    <!-- REWARDS SECTION -->
    <div id="rewards" class="content-section">
        <!-- NEW SLOTS SYSTEM -->
        <div class="xp-boost-total" id="xp-boost-display">Total: üö´ +0% XP | üí§ +0% XP</div>
        <div class="slots-container" id="slots-grid">
            <!-- Slots generated via JS -->
        </div>

        <div id="module-nonut">
            <h3 style="color:var(--accent-nn); margin-left: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">No Nut-chan</h3>
            <div class="waifu-grid">
                <div class="waifu-card bg-common" id="card-nn-special" onclick="moveToSlot(event, 'nonut', 'special', 'special.png', 'slot-bg-common')"><span id="nn-special-count" class="waifu-count count-special">0</span><img src="special.png" class="waifu-img"><div class="waifu-info"><div class="waifu-label">Special</div></div></div>
                <div class="waifu-card bg-rare" id="card-nn-shiny" onclick="moveToSlot(event, 'nonut', 'shiny', 'shiny.png', 'slot-bg-rare')"><span id="nn-shiny-count" class="waifu-count count-shiny">0</span><img src="shiny.png" class="waifu-img"><div class="waifu-info"><div class="waifu-label">Shiny</div></div></div>
                <div class="waifu-card bg-legendary" id="card-nn-legendary" onclick="moveToSlot(event, 'nonut', 'legendary', 'legendary.png', 'slot-bg-legendary')"><span id="nn-legendary-count" class="waifu-count count-legendary">0</span><img src="legendary.png" class="waifu-img"><div class="waifu-info"><div class="waifu-label">Legendary</div></div></div>
            </div>
            <div class="trade-box">
                <div class="trade-header">Card Exchange</div>
                <div class="trade-actions">
                    <button class="trade-btn" onclick="trade('nonut', 'special', 15)"><div class="trade-row"><span class="cost-silver">15</span>‚û°<span class="gain-legendary">1</span></div><div class="trade-desc">NN Special > Legend</div></button>
                    <button class="trade-btn" onclick="trade('nonut', 'shiny', 2)"><div class="trade-row"><span class="cost-gold">2</span>‚û°<span class="gain-legendary">1</span></div><div class="trade-desc">NN Shiny > Legend</div></button>
                </div>
            </div>
            <div class="progress-box">
                <div class="streak-header stats-flex"><div class="stat-item"><div class="stat-label">Streak</div><div class="stat-number"><span id="nn-streak">0</span>w</div></div><div class="stat-item"><div class="stat-label">Total</div><div class="stat-number"><span id="nn-total">0</span>w</div></div><div id="nn-next-text" class="next-reward">Next Shiny: 4w</div></div>
                <div class="progress-track"><div class="marker marker-shiny"></div><div id="nn-bar" class="progress-fill fill-nn"></div></div>
            </div>
        </div>

        <div id="module-sleep" style="margin-top:40px;">
            <h3 style="color:var(--accent-sleep); margin-left: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Sleep-chan</h3>
            <div class="waifu-grid">
                <div class="waifu-card bg-common" id="card-sl-special" onclick="moveToSlot(event, 'sleep', 'special', 'sleep_special.png', 'slot-bg-common')"><span id="sl-special-count" class="waifu-count count-special">0</span><img src="sleep_special.png" class="waifu-img"><div class="waifu-info"><div class="waifu-label">Special</div></div></div>
                <div class="waifu-card bg-rare" id="card-sl-shiny" onclick="moveToSlot(event, 'sleep', 'shiny', 'sleep_shiny.png', 'slot-bg-rare')"><span id="sl-shiny-count" class="waifu-count count-shiny">0</span><img src="sleep_shiny.png" class="waifu-img"><div class="waifu-info"><div class="waifu-label">Shiny</div></div></div>
                <div class="waifu-card bg-legendary" id="card-sl-legendary" onclick="moveToSlot(event, 'sleep', 'legendary', 'sleep_legendary.png', 'slot-bg-legendary')"><span id="sl-legendary-count" class="waifu-count count-legendary">0</span><img src="sleep_legendary.png" class="waifu-img"><div class="waifu-info"><div class="waifu-label">Legendary</div></div></div>
            </div>
            <div class="trade-box">
                <div class="trade-header">Card Exchange</div>
                <div class="trade-actions">
                    <button class="trade-btn" onclick="trade('sleep', 'special', 15)"><div class="trade-row"><span class="cost-silver">15</span>‚û°<span class="gain-legendary">1</span></div><div class="trade-desc">SL Special > Legend</div></button>
                    <button class="trade-btn" onclick="trade('sleep', 'shiny', 2)"><div class="trade-row"><span class="cost-gold">2</span>‚û°<span class="gain-legendary">1</span></div><div class="trade-desc">SL Shiny > Legend</div></button>
                </div>
            </div>
            <div class="progress-box">
                <div class="streak-header stats-flex"><div class="stat-item"><div class="stat-label">Streak</div><div class="stat-number"><span id="sl-streak">0</span>w</div></div><div class="stat-item"><div class="stat-label">Total</div><div class="stat-number"><span id="sl-total">0</span>w</div></div><div id="sl-next-text" class="next-reward">Next Shiny: 4w</div></div>
                <div class="progress-track"><div class="marker marker-shiny"></div><div id="sl-bar" class="progress-fill fill-sl"></div></div>
            </div>
        </div>
    </div>

    <!-- GALLERY SECTION -->
    <div id="gallery" class="content-section">
        <div class="stat-box">
            <h3>Unlocked Memories</h3>
            <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">Collect all 15 reward illustrations!</p>
            <div class="gallery-grid" id="gallery-container">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- STATS SECTION -->
    <div id="stats" class="content-section">
        <div id="stats-nonut" class="stat-box"><div style="max-width: 300px; margin: 0 auto;"><canvas id="fapChart"></canvas></div></div>
        <div id="stats-sleep"><div class="stat-box"><h3>Monthly Calendar (Sleep)</h3><div id="sleep-heatmap" class="heatmap-grid"></div></div><div class="stat-box"><h3>Sleep Graph (30 days)</h3><canvas id="sleepChart"></canvas></div></div>
    </div>

    <!-- SETTINGS SECTION -->
    <div id="settings" class="content-section">
        <div class="stat-box">
            <h3>Theme Selector</h3>
            <div class="theme-selector">
                <div class="theme-btn t-red unlocked" onclick="setTheme('')"></div>
                <div class="theme-btn t-blue" id="btn-theme-blue" onclick="setTheme('theme-blue')"></div>
                <div class="theme-btn t-green" id="btn-theme-green" onclick="setTheme('theme-green')"></div>
                <div class="theme-btn t-gold" id="theme-btn-gold" onclick="setTheme('theme-gold')"></div>
                <div class="theme-btn t-rainbow" id="theme-btn-rainbow" onclick="setTheme('theme-rainbow')"></div>
            </div>

            <h3>Active Trackers</h3>
            <div class="checkbox-group">
                <label class="checkbox-label"><input type="checkbox" id="toggle-nonut"> No Nut-chan Mode</label>
                <label class="checkbox-label"><input type="checkbox" id="toggle-sleep"> Sleep-chan Mode</label>
            </div>

            <h3>Settings</h3>
            <label>Target Wake-up Time:</label>
            <select id="target-time-select" style="width:100%; padding:10px; margin-bottom:15px; background:#333; color:white; border:none;"></select>
            
            <h4>Data Management</h4>
            <button class="action-btn" style="background: #0277bd; color:white;" onclick="exportData()">üíæ Export Progress</button>
            <button class="action-btn" style="background: #555; color:white;" onclick="document.getElementById('fileInput').click()">üìÇ Import Progress</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(this)" style="display:none;">
            
            <h4>Allowed Days (No-Nut)</h4>
            <div id="days-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
            
            <h4>Sleep Exempt</h4>
            <div id="exempt-list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
            
            <button onclick="saveSettings()" class="action-btn">Save Settings</button>
            <button onclick="resetData()" class="action-btn" style="background:var(--fail); color:white;">Reset All Data</button>
        </div>
    </div>

    <script>
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const titles = ["Novice", "Beginner", "Apprentice", "Disciplined", "Guardian", "Knight", "Elite", "Master", "Grandmaster", "Legend", "Mythic", "Godlike"];
        
        const audioFiles = ['voice1.mp3', 'voice2.mp3', 'voice3.mp3', 'voice4.mp3', 'voice5.mp3']; 
        const successAudioFiles = ['success1.mp3', 'success2.mp3', 'success3.mp3', 'success4.mp3'];
        
        // 15 REWARD IMAGES
        const rewardImages = [];
        for(let i=1; i<=15; i++) rewardImages.push(`reward${i}.png`);
        
        // 21 REWARD VOICES
        const rewardVoiceFiles = [];
        for(let i=1; i<=21; i++) rewardVoiceFiles.push(`reward_voice${i}.mp3`);
        
        const rewardLines = [
            "You did it like a final-boss speedrun! It's your reward day... Wanna take me like a princess?",
            "Your willpower today deserves its own theme song! Wanna do me while we listen to it?",
            "Your self-control just earned a platinum trophy! And some time with me... If you want?",
            "You're amazing! You have deserved some relief. Want me to help you with that...?",
            "Today is your free day! I'm here if you want to indulge... hehe.",
            "Calendar says 'Allowed'. My body says 'Available'. Your eyes say 'Hungry'. Wanna use me? You have deserved it.",
            "Finally! I was getting bored of watching you just sleep and work. Come over here and show me what that pent-up energy can do.",
            "It's dangerous to go alone! Take me... to bed. Right now. No cheat codes needed. Wanna do that?",
            "You have 24 hours until the server resets. If you wanna do me you'd better hurry!",
            "You rolled a Natural 20 on Self-Control! That means you get a Critical Success in the bedroom today. Lucky you~",
            "Achievement Unlocked: Master of Self-Control! Your prize is... Me! Wanna do it?"
        ];
        const panicLines = [
            "You are the Main Character. Main Characters don't give in to weakness!",
            "Hold the line! The urge is just a mini-boss. You can beat it!",
            "Is 5 seconds of pleasure really worth losing your progress? Stay focused!",
            "Discipline is sexy. Show me how strong you really are.",
            "Not today! We have a goal to reach. Keep your hands where I can see them!",
            "Remember why you started. Don't trade what you want most for what you want now.",
            "Stay strong! I know it's hard, but I believe in you.",
            "Just breathe. The urge will pass. You are stronger than your impulses.",
            "Save that energy for your goals (or for our reward day). Don't waste it!",
            "I'm right here with you. Let's get through today together, okay?"
        ];

        let config = { 
            allowedDays:[2,5], 
            sleepExemptDays:[5,6], 
            targetWakeTime:8, 
            wakeTimes:[{v:7,l:'07:00'},{v:8,l:'08:00'},{v:9,l:'09:00'},{v:10,l:'10:00'},{v:11,l:'11:00'},{v:12,l:'12:00+'}],
            modules: { nonut: true, sleep: true },
            activeTheme: '' 
        };
        let rewards = { nonut:{special:0,shiny:0,legendary:0,streak:0}, sleep:{special:0,shiny:0,legendary:0,streak:0}, lifetime_legendaries: 0 };
        let rpg = { xp: 0 }; 
        let unlocks = { themes: [], gallery: [] }; 
        // NEW SLOTS SYSTEM (Array of 3 items)
        let equippedSlots = [null, null, null];
        let equipped = { theme: '' };
        let currentWeek = [], archive = [];
        let currentAudio = null;
        let quoteInterval = null;

        function init() {
            if(localStorage.getItem('wt_config')) {
                let tempConfig = JSON.parse(localStorage.getItem('wt_config'));
                tempConfig.wakeTimes = config.wakeTimes;
                if(!tempConfig.modules) tempConfig.modules = { nonut: true, sleep: true };
                config = tempConfig;
            }
            if(localStorage.getItem('wt_rewards')) {
                let r = JSON.parse(localStorage.getItem('wt_rewards'));
                if(r.lifetime_legendaries === undefined) r.lifetime_legendaries = r.nonut.legendary + r.sleep.legendary;
                // Ensure counters exist for new drop logic
                if(r.nonut && r.nonut.totalDrops === undefined) { r.nonut.totalDrops = 0; r.nonut.dropCounter = 0; }
                if(r.sleep && r.sleep.totalDrops === undefined) { r.sleep.totalDrops = 0; r.sleep.dropCounter = 0; }
                rewards = r;
            }
            if(localStorage.getItem('wt_rpg')) rpg = JSON.parse(localStorage.getItem('wt_rpg'));
            if(localStorage.getItem('wt_unlocks')) {
                unlocks = JSON.parse(localStorage.getItem('wt_unlocks'));
                if(!unlocks.gallery) unlocks.gallery = []; 
            }
            if(localStorage.getItem('wt_slots')) {
                equippedSlots = JSON.parse(localStorage.getItem('wt_slots'));
                // SAFETY: Ensure max 3 slots if old data exists
                if(equippedSlots.length > 3) {
                    equippedSlots = equippedSlots.slice(0, 3);
                    save();
                }
            }
            if(localStorage.getItem('wt_equipped')) equipped = JSON.parse(localStorage.getItem('wt_equipped'));
            
            if(localStorage.getItem('wt_week')) currentWeek = JSON.parse(localStorage.getItem('wt_week'));
            else initWeek();
            if(localStorage.getItem('wt_archive')) archive = JSON.parse(localStorage.getItem('wt_archive'));

            applyTheme(equipped.theme, false);
            if(config.activeTheme) document.body.className = config.activeTheme;
            
            updateFabState();
            renderLog(); renderRewards(); renderSettingsUI(); renderRPG(); renderStats(); updateThemeUI(); renderGallery();
        }

        function initWeek() {
            currentWeek = days.map((d,i) => ({ day:d, idx:i, allowed:config.allowedDays.includes(i), exempt:config.sleepExemptDays.includes(i), sleep:null, kept:null }));
            save();
        }
        function save() {
            localStorage.setItem('wt_week', JSON.stringify(currentWeek));
            localStorage.setItem('wt_archive', JSON.stringify(archive));
            localStorage.setItem('wt_config', JSON.stringify(config));
            localStorage.setItem('wt_rewards', JSON.stringify(rewards));
            localStorage.setItem('wt_rpg', JSON.stringify(rpg));
            localStorage.setItem('wt_unlocks', JSON.stringify(unlocks));
            localStorage.setItem('wt_equipped', JSON.stringify(equipped));
            localStorage.setItem('wt_slots', JSON.stringify(equippedSlots));
        }

        // --- ANIMATION UTILS ---
        function flyItem(startEl, endEl, imgSrc, callback) {
            if(!startEl || !endEl) {
                if(callback) callback();
                return;
            }
            const startRect = startEl.getBoundingClientRect();
            const endRect = endEl.getBoundingClientRect();

            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'flying-card';
            img.style.width = startRect.width + 'px';
            img.style.height = startRect.height + 'px';
            img.style.top = startRect.top + 'px';
            img.style.left = startRect.left + 'px';
            document.body.appendChild(img);

            // Trigger reflow
            void img.offsetWidth;

            img.style.top = endRect.top + 'px';
            img.style.left = endRect.left + 'px';
            img.style.width = endRect.width + 'px';
            img.style.height = endRect.height + 'px';

            setTimeout(() => {
                img.remove();
                if(callback) callback();
            }, 500); // Match transition duration
        }

        // --- SLOTS LOGIC ---
        function moveToSlot(e, category, type, imgSrc, bgClass) {
            const count = rewards[category][type];
            if(count <= 0) { alert("You don't have any of this card left in inventory!"); return; }

            const cardElement = e.currentTarget;
            let targetSlotIndex = -1;
            let existingSlotIndex = equippedSlots.findIndex(s => s && s.category === category && s.type === type);
            
            if (existingSlotIndex !== -1) {
                targetSlotIndex = existingSlotIndex;
            } else {
                targetSlotIndex = equippedSlots.findIndex(s => s === null);
            }

            if (targetSlotIndex === -1) {
                alert("All 3 slots are full! Tap a slot to remove a card first.");
                return;
            }

            const targetSlotEl = document.getElementById('slot-' + targetSlotIndex);

            flyItem(cardElement, targetSlotEl, imgSrc, () => {
                if (existingSlotIndex !== -1) {
                    equippedSlots[existingSlotIndex].count++;
                } else {
                    equippedSlots[targetSlotIndex] = { 
                        category: category, type: type, img: imgSrc, bg: bgClass, count: 1 
                    };
                }
                rewards[category][type]--;
                save();
                renderRewards();
            });
        }

        function returnFromSlot(index) {
            const slot = equippedSlots[index];
            if (!slot) return;

            const slotEl = document.getElementById('slot-' + index);
            const targetCardId = `card-${slot.category === 'nonut' ? 'nn' : 'sl'}-${slot.type}`;
            const targetCardEl = document.getElementById(targetCardId);

            flyItem(slotEl, targetCardEl, slot.img, () => {
                rewards[slot.category][slot.type]++;
                slot.count--;
                if (slot.count <= 0) {
                    equippedSlots[index] = null;
                }
                save();
                renderRewards();
            });
        }

        function calculateSlotBonus(slot) {
            if(!slot) return 0;
            const count = slot.count;
            if (count === 0) return 0;

            if (slot.type === 'special') {
                return 3 + Math.floor(count / 5);
            } else if (slot.type === 'shiny') {
                return 5 + Math.floor(count / 2);
            } else if (slot.type === 'legendary') {
                return 8 + ((count - 1) * 3); 
            }
            return 0;
        }

        function getMultiplierForCategory(targetCategory) {
            let total = 0;
            equippedSlots.forEach(slot => {
                if (slot && slot.category === targetCategory) {
                    total += calculateSlotBonus(slot);
                }
            });
            return total;
        }

        function getTotalMultiplier() {
            let total = 0;
            equippedSlots.forEach(slot => {
                total += calculateSlotBonus(slot);
            });
            return total;
        }

        // --- GALLERY LOGIC ---
        function renderGallery() {
            const container = document.getElementById('gallery-container');
            container.innerHTML = '';
            rewardImages.forEach((img) => {
                const isUnlocked = unlocks.gallery.includes(img);
                const div = document.createElement('div');
                div.className = isUnlocked ? 'gallery-item unlocked' : 'gallery-item locked';
                if(isUnlocked) {
                    div.innerHTML = `<img src="${img}" onclick="openModal('${img}')">`;
                } else {
                    div.innerHTML = `<div class="lock-icon">?</div>`;
                }
                container.appendChild(div);
            });
        }

        // --- THEMES ---
        function setTheme(themeName) {
            if(themeName === '') {
                document.body.className = ''; config.activeTheme = ''; save(); return;
            }
            let required = 0;
            if (themeName === 'theme-blue' || themeName === 'theme-green') required = 1;
            if (themeName === 'theme-gold') required = 5;
            if (themeName === 'theme-rainbow') required = 10;

            if (rewards.lifetime_legendaries >= required) {
                document.body.className = themeName; config.activeTheme = themeName; save();
            } else { 
                alert(`Locked! You need ${required} Lifetime Legendaries to unlock this theme.\nYou currently have: ${rewards.lifetime_legendaries}`); 
            }
        }

        function updateThemeUI() {
            const total = rewards.lifetime_legendaries;
            if(total >= 1) { document.querySelector('.t-blue').classList.add('unlocked'); document.querySelector('.t-green').classList.add('unlocked'); }
            if(total >= 5) document.getElementById('theme-btn-gold').classList.add('unlocked');
            if(total >= 10) document.getElementById('theme-btn-rainbow').classList.add('unlocked');
        }
        
        function applyTheme(themeName, saveState = true) {
            document.body.className = ""; 
            if(themeName) document.body.classList.add('theme-' + themeName);
            if(saveState) { config.activeTheme = themeName; save(); }
        }

        // --- BUTTON LOGIC ---
        function startQuoteRotation(lines) {
            if(quoteInterval) clearInterval(quoteInterval);
            const bubble = document.getElementById('waifuBubble');
            const updateQuote = () => { bubble.innerHTML = lines[Math.floor(Math.random() * lines.length)]; };
            updateQuote();
            quoteInterval = setInterval(updateQuote, 20000);
        }

        function updateFabState() {
            const jsDay = new Date().getDay();
            const appDay = jsDay === 0 ? 6 : jsDay - 1;
            
            const btn = document.getElementById('globalPanicBtn');
            const img = document.getElementById('fabImg');
            const bubble = document.getElementById('waifuBubble');

            const isSettings = document.getElementById('settings').classList.contains('active');
            if(isSettings) { btn.style.display = 'none'; bubble.style.display = 'none'; if(quoteInterval) clearInterval(quoteInterval); return; }
            btn.style.display = 'flex';
            bubble.style.display = 'block';

            if(config.modules.nonut && config.allowedDays.includes(appDay)) {
                img.src = 'reward_button.png'; 
                btn.onclick = triggerReward;
                startQuoteRotation(rewardLines);
            } else {
                img.src = 'panic_button.png';
                btn.onclick = triggerPanic;
                startQuoteRotation(panicLines);
            }
        }

        // --- HELPERS ---
        function playAudioWithFallback(fileArray, modalId) {
            if(fileArray.length === 0) return;
            const file = fileArray[Math.floor(Math.random() * fileArray.length)];
            if(currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
            currentAudio = new Audio(file);
            currentAudio.play().catch(e => console.log("Audio play error", e));
        }
        function stopAudio() { if(currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; } }

        // --- TRIGGERS ---
        function triggerPanic() { 
            let daysLeft = 0;
            const today = new Date().getDay();
            const appDay = today === 0 ? 6 : today - 1;
            for(let i = 1; i <= 7; i++) {
                const next = (appDay + i) % 7;
                if(config.allowedDays.includes(next)) {
                    daysLeft = i;
                    break;
                }
            }
            let fileToPlay = "";
            if(daysLeft === 1) fileToPlay = `panic_1day_${Math.floor(Math.random() * 20) + 1}.mp3`;
            else if (daysLeft === 2) fileToPlay = `panic_2days_${Math.floor(Math.random() * 12) + 1}.mp3`;
            else if (daysLeft === 3) fileToPlay = `panic_3days_${Math.floor(Math.random() * 9) + 1}.mp3`;
            else fileToPlay = `panic_long_${Math.floor(Math.random() * 4) + 1}.mp3`;

            document.getElementById('panicModal').style.display = 'flex'; 
            if(currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
            currentAudio = new Audio(fileToPlay);
            currentAudio.play();
        }
        function stopPanic() { document.getElementById('panicModal').style.display = 'none'; stopAudio(); }
        function triggerSuccess() { document.getElementById('successText').style.display = 'block'; document.getElementById('successModal').style.display = 'flex'; triggerFireworks(window.innerWidth/2, window.innerHeight/2); playAudioWithFallback(successAudioFiles, 'successModal'); }
        function stopSuccess() { document.getElementById('successModal').style.display = 'none'; stopAudio(); }
        function triggerWeeklySuccess() { document.getElementById('weeklyText').style.display = 'block'; document.getElementById('weeklyModal').style.display = 'flex'; if(currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; } currentAudio = new Audio('weekly.mp3'); currentAudio.play(); let lc=0; const fl=setInterval(()=>{triggerFireworks(Math.random()*window.innerWidth, Math.random()*window.innerHeight*0.8);lc++;if(lc>15)clearInterval(fl)},300); }
        function stopWeekly() { document.getElementById('weeklyModal').style.display = 'none'; stopAudio(); archive.push({date:new Date(), data:[...currentWeek]}); initWeek(); renderLog(); renderRewards(); renderStats(); }
        
        function triggerReward() {
            document.getElementById('waifuBubble').style.display = 'none';
            const today = new Date().toLocaleDateString();
            let saved = JSON.parse(localStorage.getItem('wt_daily_reward') || '{}');
            let selectedImg;

            if (saved.date === today && saved.img) {
                selectedImg = saved.img;
            } else {
                let available = rewardImages.filter(img => !unlocks.gallery.includes(img));
                if (available.length === 0) available = rewardImages;
                selectedImg = available[Math.floor(Math.random() * available.length)];
                localStorage.setItem('wt_daily_reward', JSON.stringify({ date: today, img: selectedImg }));
                if(!unlocks.gallery.includes(selectedImg)) {
                    unlocks.gallery.push(selectedImg);
                    save();
                    renderGallery();
                }
            }
            document.getElementById('rewardImg').src = selectedImg;
            document.getElementById('rewardModal').style.display = 'flex';
            playAudioWithFallback(rewardVoiceFiles, 'rewardModal');
            triggerFireworks(window.innerWidth/2, window.innerHeight/2);
        }
        function stopReward() { document.getElementById('rewardModal').style.display = 'none'; document.getElementById('waifuBubble').style.display = 'block'; }

        // --- DROP LOGIC (MODIFIED: 5th drop = Shiny) ---
        function checkDayDrop(category) {
            let r = rewards[category];
            if(r.totalDrops === undefined) { r.totalDrops = 0; r.dropCounter = 0; }

            r.dropCounter++;
            
            let threshold = 5; 
            if (r.totalDrops < 5) threshold = 1; 
            else if (r.totalDrops < 10) threshold = 3; 

            if (r.dropCounter >= threshold) {
                r.totalDrops++;
                r.dropCounter = 0;
                
                if (r.totalDrops % 5 === 0) {
                    r.shiny++;
                    return 'shiny';
                } else {
                    r.special++;
                    return 'special';
                }
            }
            return null;
        }

        function checkDayCompletion(i) {
            const d = currentWeek[i];
            let sleepOk = true; if(config.modules.sleep) sleepOk = d.sleep !== null && (d.exempt || d.sleep <= config.targetWakeTime);
            let nutOk = true; if(config.modules.nonut) nutOk = d.allowed ? (d.kept !== null) : (d.kept === true);
            if (sleepOk && nutOk) triggerSuccess();
        }

        function trade(category, type, cost) { let b = rewards[category]; if (b[type] >= cost) { if(confirm(`Trade ${cost} ${type} for 1 Legendary?`)) { b[type] -= cost; b.legendary++; rewards.lifetime_legendaries++; save(); renderRewards(); updateThemeUI(); triggerFireworks(window.innerWidth/2, window.innerHeight/2); alert("Trade Successful!"); } } else { alert(`Not enough ${type}!`); } }
        
        function getLevelData(totalXP) { 
            let level = 1;
            let cost = 100; 
            let remaining = totalXP;
            while (remaining >= cost) {
                remaining -= cost;
                level++;
                cost += 10; 
            }
            return { level, currentXP: remaining, nextLevelCost: cost }; 
        }
        
        // MODIFIED: Consistent Text
        function addXP(amount, sourceCategory, silent = false) {
            let boostPercent = 0;
            if (sourceCategory) {
                boostPercent = getMultiplierForCategory(sourceCategory);
            }
            
            const totalAmount = Math.floor(amount * (1 + boostPercent / 100));

            const oldD = getLevelData(rpg.xp); 
            rpg.xp += totalAmount; 
            const newD = getLevelData(rpg.xp); 
            
            if (silent) {
                save();
                renderRPG();
                return;
            }

            let msgHTML = `<span class="reward-title">SUCCESS!</span>+${totalAmount} XP`;
            
            const dropType = sourceCategory ? checkDayDrop(sourceCategory) : null;
            if (dropType) {
                const name = sourceCategory === 'nonut' ? 'No Nut-chan' : 'Sleep-chan';
                const typeLabel = dropType === 'shiny' ? 'Shiny' : 'Special';
                const icon = dropType === 'shiny' ? '‚ú®' : (sourceCategory === 'nonut' ? 'üíñ' : 'üí§');
                // MODIFIED: Consistent Format
                msgHTML += `<div class="reward-item" style="color:#fff">BONUS: ${icon} 1x ${typeLabel} ${name}</div>`;
            }

            if (newD.level > oldD.level) { 
                msgHTML += `<div class="reward-item" style="color:#00e5ff; margin-top:10px;">LEVEL UP! Lv ${newD.level}</div>`;
                if(config.modules.nonut) { rewards.nonut.special++; msgHTML += `<div class="reward-item">üíñ 1x Special No Nut-chan</div>`; }
                if(config.modules.sleep) { rewards.sleep.special++; msgHTML += `<div class="reward-item">üí§ 1x Special Sleep-chan</div>`; }
                triggerFireworks(window.innerWidth/2, window.innerHeight/2);
            }
            
            msgHTML += `<div class="tap-hint">(Tap to close)</div>`;
            
            document.getElementById('successText').innerHTML = msgHTML;
            document.getElementById('successText').style.display = 'block'; 
            document.getElementById('successModal').style.display = 'flex'; 
            playAudioWithFallback(successAudioFiles, 'successModal');
            
            save(); 
            renderRPG(); 
        }
        
        function renderRPG() { const d = getLevelData(rpg.xp); document.getElementById('rpg-level').innerText = d.level; document.getElementById('rpg-current-xp').innerText = d.currentXP; document.getElementById('rpg-next-xp').innerText = d.nextLevelCost; document.getElementById('xp-bar').style.width = Math.min((d.currentXP/d.nextLevelCost)*100,100)+'%'; let ti=Math.floor((d.level-1)/5); if(ti>=titles.length) ti=titles.length-1; document.getElementById('rpg-title').innerText = titles[ti]; }

        // --- RENDER LOGIC ---
        function renderLog() {
            const container = document.getElementById('week-container'); container.innerHTML = '';
            let jsDay = new Date().getDay(); let todayIdx = jsDay === 0 ? 6 : jsDay - 1; 

            currentWeek.forEach((d, i) => {
                const card = document.createElement('div');
                let classes = 'day-card';
                if(config.modules.nonut && d.allowed) classes += ' allowed-day'; 
                if(config.modules.sleep && d.exempt) classes += ' exempt-day'; 
                if(i === todayIdx) classes += ' is-today';
                if((!config.modules.sleep || d.sleep !== null) && (!config.modules.nonut || d.kept !== null)) classes += ' completed';
                card.className = classes;
                let badges = '';
                if(config.modules.nonut && d.allowed) badges += '<span class="badge badge-allowed">Allowed</span>';
                if(config.modules.sleep && d.exempt) badges += '<span class="badge badge-exempt">Sleep In</span>';
                let content = `<div class="card-header"><span class="day-title">${d.day}</span><div class="header-right"><div class="badges">${badges}</div></div></div>`;
                if(config.modules.sleep) {
                    if (d.sleep !== null) {
                        const sleepText = d.sleep <= config.targetWakeTime || d.exempt ? '‚úÖ On Time' : '‚ùå Overslept';
                        content += `<div class="summary-view"><div class="summary-text"><b>üí§ Sleep:</b> ${findLabel(d.sleep)} (${sleepText})</div><button class="edit-btn" onclick="resetDay(${i}, 'sleep')">Edit</button></div>`;
                    } else {
                        let sleepBtns = ''; config.wakeTimes.forEach(t => { sleepBtns += `<button class="sleep-btn ${d.sleep===t.v?'selected':''}" onclick="setSleep(${i},${t.v})">${t.l}</button>`; });
                        content += `<div style="margin-bottom:5px;font-size:0.9rem;">üí§ Woke up:</div><div class="btn-grid">${sleepBtns}</div>`;
                    }
                }
                if(config.modules.nonut) {
                    if (d.kept !== null) {
                        let nutText = d.allowed ? (d.kept ? '‚úÖ Indulged' : '‚è∏Ô∏è Skipped') : (d.kept ? '‚úÖ Success' : '‚ùå Failed');
                        content += `<div class="summary-view"><div class="summary-text"><b>üö´ Status:</b> ${nutText}</div><button class="edit-btn" onclick="resetDay(${i}, 'kept')">Edit</button></div>`;
                    } else {
                        let nutBtns = d.allowed ? `<button class="fap-btn allowed-action" onclick="setKept(${i},true)">Indulge</button><button class="fap-btn allowed-skip" onclick="setKept(${i},false)">Skip</button>` : `<button class="fap-btn success-btn" onclick="setKept(${i},true)">Success</button><button class="fap-btn fail-btn" onclick="setKept(${i},false)">Fail</button>`;
                        content += `<div style="margin-bottom:5px;font-size:0.9rem;">üö´ Status:</div><div class="btn-grid" style="grid-template-columns:1fr 1fr;">${nutBtns}</div>`;
                    }
                }
                card.innerHTML = content; container.appendChild(card);
            });
        }

        function findLabel(val) { const t = config.wakeTimes.find(x => x.v === val); return t ? t.l : val; }
        
        function setSleep(i, v) { 
            if (currentWeek[i].sleep === null) { 
                if (currentWeek[i].exempt || v <= config.targetWakeTime) addXP(20, 'sleep'); 
            } 
            currentWeek[i].sleep = v; 
            save(); 
            renderLog(); 
        }
        
        function setKept(i, v) { 
            if(currentWeek[i].kept === null) { 
                if(!currentWeek[i].allowed && v === true) addXP(25, 'nonut'); 
                else if(currentWeek[i].allowed) addXP(10, 'nonut'); 
            } 
            currentWeek[i].kept = v; 
            save(); 
            renderLog(); 
        }
        
        function resetDay(i, type) { if(type === 'sleep') currentWeek[i].sleep = null; if(type === 'kept') currentWeek[i].kept = null; save(); renderLog(); }

        function archiveWeek() {
            let incomplete = false;
            for(let d of currentWeek) { if(config.modules.sleep && d.sleep === null) incomplete = true; if(config.modules.nonut && d.kept === null) incomplete = true; }
            if(incomplete) { if(!confirm("WARNING: Some active days are incomplete. Proceed?")) return; } else { if(!confirm("Archive week?")) return; }
            
            let msgHTML = `<span class="reward-title">WEEKLY REWARDS</span>`;
            let hasRewards = false;

            if(config.modules.nonut) {
                const nnReq = currentWeek.filter(d => !d.allowed);
                if(nnReq.length > 0 && nnReq.every(d => d.kept === true)) {
                    rewards.nonut.streak++; rewards.nonut.special++; hasRewards = true;
                    addXP(50, null, true); 
                    msgHTML += `<div class="reward-item">üíñ 1x Special No Nut-chan (+50 XP)</div>`;
                    if(rewards.nonut.streak > 0 && rewards.nonut.streak % 4 === 0) { rewards.nonut.shiny++; addXP(100, null, true); msgHTML += `<div class="reward-item" style="color:var(--gold)">‚ú® 1x Shiny No Nut-chan (+100 XP)</div>`; }
                    if(rewards.nonut.streak > 0 && rewards.nonut.streak % 8 === 0) { rewards.nonut.legendary++; rewards.lifetime_legendaries++; addXP(200, null, true); msgHTML += `<div class="reward-item" style="color:var(--legendary)">üëë 1x Legendary No Nut-chan (+200 XP)</div>`; }
                } else { rewards.nonut.streak = 0; msgHTML += `<div class="reward-item" style="color:var(--fail)">No-Nut Streak Reset</div>`; }
            }
            if(config.modules.sleep) {
                const slReq = currentWeek.filter(d => !d.exempt);
                if(slReq.length > 0 && slReq.every(d => d.sleep !== null && d.sleep <= config.targetWakeTime)) {
                    rewards.sleep.streak++; rewards.sleep.special++; hasRewards = true;
                    addXP(50, null, true);
                    msgHTML += `<div class="reward-item">üí§ 1x Special Sleep-chan (+50 XP)</div>`;
                    if(rewards.sleep.streak > 0 && rewards.sleep.streak % 4 === 0) { rewards.sleep.shiny++; addXP(100, null, true); msgHTML += `<div class="reward-item" style="color:var(--gold)">‚ú® 1x Shiny Sleep-chan (+100 XP)</div>`; }
                    if(rewards.sleep.streak > 0 && rewards.sleep.streak % 8 === 0) { rewards.sleep.legendary++; rewards.lifetime_legendaries++; addXP(200, null, true); msgHTML += `<div class="reward-item" style="color:var(--legendary)">üëë 1x Legendary Sleep-chan (+200 XP)</div>`; }
                } else { rewards.sleep.streak = 0; msgHTML += `<div class="reward-item" style="color:var(--fail)">Sleep Streak Reset</div>`; }
            }
            save(); 
            
            if(hasRewards) {
                msgHTML += `<div class="tap-hint">(Tap to close)</div>`;
                document.getElementById('weeklyText').innerHTML = msgHTML;
                triggerWeeklySuccess();
            } else { 
                alert("Streak lost. Better luck next week."); 
                archive.push({date:new Date(), data:[...currentWeek]}); initWeek(); renderLog(); renderRewards(); renderStats(); 
            }
        }

        // NEW RENDER REWARDS WITH DYNAMIC BOOST TEXT
        function renderRewards() {
            const slotsDiv = document.getElementById('slots-grid');
            slotsDiv.innerHTML = '';
            equippedSlots.forEach((slot, index) => {
                const box = document.createElement('div');
                box.id = 'slot-' + index;
                box.className = slot ? `slot-box filled ${slot.bg}` : 'slot-box';
                
                if (slot) {
                    const bonus = calculateSlotBonus(slot);
                    box.innerHTML = `
                        <img src="${slot.img}" class="slot-icon">
                        <span class="slot-bonus">+${bonus}% XP</span>
                        <span class="slot-stack">x${slot.count}</span>
                    `;
                    box.onclick = () => returnFromSlot(index);
                } else {
                    box.innerHTML = '<span style="font-size:1.5rem; color:#444;">+</span>';
                    box.onclick = () => alert("Tap a card below to move one copy here!");
                }
                slotsDiv.appendChild(box);
            });
            
            const nnBoost = getMultiplierForCategory('nonut');
            const slBoost = getMultiplierForCategory('sleep');
            
            let boostText = "Total: ";
            let parts = [];
            if (config.modules.nonut) { parts.push(`üö´ +${nnBoost}% XP`); }
            if (config.modules.sleep) { parts.push(`üí§ +${slBoost}% XP`); }
            
            document.getElementById('xp-boost-display').innerText = parts.length > 0 ? "Total: " + parts.join(" | ") : "";

            renderModule('nonut', 'nn');
            renderModule('sleep', 'sl');
            updateThemeUI();
        }

        function renderModule(cat, prefix) {
            const div = document.getElementById(`module-${cat}`);
            if (!config.modules[cat]) { div.style.display='none'; return; }
            div.style.display='block';
            
            document.getElementById(`${prefix}-special-count`).innerText = rewards[cat].special;
            document.getElementById(`${prefix}-shiny-count`).innerText = rewards[cat].shiny;
            document.getElementById(`${prefix}-legendary-count`).innerText = rewards[cat].legendary;
            document.getElementById(`${prefix}-streak`).innerText = rewards[cat].streak;
            
            updateBar(prefix, rewards[cat].streak);
            let t=0; 
            if(cat === 'nonut') archive.forEach(w=>{const r=w.data.filter(d=>!d.allowed); if(r.length>0 && r.every(d=>d.kept===true)) t++;}); 
            else archive.forEach(w=>{const r=w.data.filter(d=>!d.exempt); if(r.length>0 && r.every(d=>d.sleep!==null && d.sleep<=config.targetWakeTime)) t++;}); 
            document.getElementById(`${prefix}-total`).innerText = t;
        }

        function updateBar(prefix, streak) { let cyclePos = streak % 8; if (streak > 0 && cyclePos === 0) cyclePos = 8; document.getElementById(`${prefix}-bar`).style.width = (cyclePos / 8) * 100 + '%'; let msg = cyclePos < 4 ? `Next Shiny: ${4 - cyclePos}w` : (cyclePos < 8 ? `Next Legendary: ${8 - cyclePos}w` : "Level Up! New cycle next week."); document.getElementById(`${prefix}-next-text`).innerText = msg; }
        
        function renderStats() { 
            document.getElementById('stats-nonut').style.display = config.modules.nonut ? 'block' : 'none';
            document.getElementById('stats-sleep').style.display = config.modules.sleep ? 'block' : 'none';
            if(config.modules.sleep) {
                const hm = document.getElementById('sleep-heatmap'); hm.innerHTML = ''; let all = []; archive.slice(-4).forEach(w => all.push(...w.data)); all.push(...currentWeek); all.slice(-28).forEach(d => { const el = document.createElement('div'); el.className = 'heatmap-day'; el.innerText = d.day.substring(0,1); if(d.sleep===null) el.style.background='#222'; else if(d.exempt) el.className+=' neutral'; else if(d.sleep<=config.targetWakeTime) el.className+=' success'; else el.className+=' fail'; hm.appendChild(el); }); 
                const ctx = document.getElementById('sleepChart').getContext('2d'); const pts = all.filter(d=>d.sleep!==null).slice(-30); if(window.sleepChartInstance) window.sleepChartInstance.destroy(); window.sleepChartInstance = new Chart(ctx, { type:'line', data:{ labels:pts.map(d=>d.day.substring(0,3)), datasets:[{ label:'Time', data:pts.map(d=>d.sleep), borderColor:'#7c4dff', tension:0.3 }] }, options:{ scales:{y:{min:6,max:13}}, plugins:{legend:{display:false}} } }); 
            }
            if(config.modules.nonut) {
                let nnWins = 0, nnLosses = 0; archive.forEach(w => { const req = w.data.filter(d => !d.allowed); if(req.length === 0) return; const isWin = req.every(d => d.kept === true); if(isWin) nnWins++; else nnLosses++; }); 
                const ctxF = document.getElementById('fapChart').getContext('2d'); if(window.fapChartInstance) window.fapChartInstance.destroy(); window.fapChartInstance = new Chart(ctxF, { type: 'doughnut', data: { labels: ['Success', 'Fail'], datasets: [{ data: [nnWins, nnLosses], backgroundColor: ['#00c853', '#d50000'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } } } }); 
            }
        }

        function renderSettingsUI() {
            document.getElementById('toggle-nonut').checked = config.modules.nonut;
            document.getElementById('toggle-sleep').checked = config.modules.sleep;
            const sel = document.getElementById('target-time-select'); sel.innerHTML = ''; config.wakeTimes.forEach(t => { sel.innerHTML += `<option value="${t.v}" ${config.targetWakeTime==t.v?'selected':''}>${t.l}</option>`; }); 
            const makeChecks = (id, src, all) => { const c = document.getElementById(id); c.innerHTML=''; all.forEach((d,i)=>{ c.innerHTML+=`<label><input type="checkbox" value="${i}" ${src.includes(i)?'checked':''}> ${d}</label>`; }); }; makeChecks('days-list', config.allowedDays, days); makeChecks('exempt-list', config.sleepExemptDays, days);
        }

        function saveSettings() {
            config.modules.nonut = document.getElementById('toggle-nonut').checked;
            config.modules.sleep = document.getElementById('toggle-sleep').checked;
            config.targetWakeTime = parseFloat(document.getElementById('target-time-select').value);
            const getVals = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb=>parseInt(cb.value));
            config.allowedDays = getVals('days-list'); config.sleepExemptDays = getVals('exempt-list');
            currentWeek.forEach((d, i) => { d.allowed = config.allowedDays.includes(i); d.exempt = config.sleepExemptDays.includes(i); });
            save(); renderLog(); renderRewards(); renderStats(); updateFabState(); alert("Settings saved!");
        }

        function resetData(){ if(confirm("WARNING: All data will be deleted.")) { localStorage.clear(); location.reload(); } }
        function switchTab(id) { document.querySelectorAll('.content-section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); if(id==='stats') renderStats(); if(id==='gallery') renderGallery(); updateFabState(); if(id==='rewards') renderRewards(); }
        function openModal(src){ document.getElementById('modalImg').src=src; document.getElementById('imgModal').style.display='flex'; }
        function exportData() { const data = { config, rewards, rpg, currentWeek, archive, exportDate: new Date().toISOString() }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); const a = document.createElement('a'); a.href = dataStr; a.download = "waifu_tracker_backup.json"; a.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if(json.config) localStorage.setItem('wt_config', JSON.stringify(json.config)); if(json.rewards) localStorage.setItem('wt_rewards', JSON.stringify(json.rewards)); if(json.rpg) localStorage.setItem('wt_rpg', JSON.stringify(json.rpg)); if(json.currentWeek) localStorage.setItem('wt_week', JSON.stringify(json.currentWeek)); if(json.archive) localStorage.setItem('wt_archive', JSON.stringify(json.archive)); if(json.unlocks) localStorage.setItem('wt_unlocks', JSON.stringify(json.unlocks)); if(json.equipped) localStorage.setItem('wt_equipped', JSON.stringify(json.equipped)); if(json.slots) localStorage.setItem('wt_slots', JSON.stringify(json.slots)); alert("Data imported!"); location.reload(); } catch(err) { alert("Import error."); } }; reader.readAsText(file); }
        function triggerFireworks(x, y) { const c=document.getElementById('fireworksCanvas'), cx=c.getContext('2d'); c.width=window.innerWidth; c.height=window.innerHeight; let startX=x||c.width/2; let startY=y||c.height/2; let p=[]; for(let i=0;i<60;i++) p.push({x:startX, y:startY, vx:(Math.random()-.5)*12, vy:(Math.random()-.5)*12, c:`hsl(${Math.random()*360},100%,50%)`, a:1}); function anim(){ cx.clearRect(0,0,c.width,c.height); p.forEach((k,i)=>{k.x+=k.vx;k.y+=k.vy;k.vy+=0.1;k.a-=0.02;cx.globalAlpha=k.a;cx.fillStyle=k.c;cx.fillRect(k.x,k.y,4,4);if(k.a<=0)p.splice(i,1)}); if(p.length)requestAnimationFrame(anim); } anim(); }

        init();
    </script>
</body>
</html>